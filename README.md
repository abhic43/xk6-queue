# xk6-queue

A k6 extension that provides thread-safe queue functionality for sharing data between Virtual Users (VUs) and scenarios during load testing.

## Features

- **Thread-safe operations**: All queue operations are safe for concurrent access across multiple VUs
- **Named queues**: Support for multiple independent queues identified by name
- **Timeout support**: Pop operations with configurable timeout
- **Non-blocking operations**: Check queue status without blocking
- **Cross-VU data sharing**: Solves the problem of data isolation between k6 Virtual Users

## Installation

To build k6 with this extension, you need to use [xk6](https://github.com/grafana/xk6):

```bash
# Install xk6
go install go.k6.io/xk6/cmd/xk6@latest

# Build k6 with the queue extension
xk6 build --with github.com/abhic43/xk6-queue@latest
```

This will create a `k6` binary in your current directory that includes the queue extension.

## Usage

Import the extension in your k6 script:

```javascript
import queue from 'k6/x/queue';
```

### Basic Operations

```javascript
import queue from 'k6/x/queue';

export default function () {
    // Push items to a queue
    queue.push('orders', 'order-123');
    queue.push('orders', 'order-456');
    
    // Pop items from a queue
    let order = queue.pop('orders');
    console.log('Got order:', order); // order-123
    
    // Check queue size
    console.log('Queue size:', queue.size('orders')); // 1
    
    // Check if queue is empty
    console.log('Is empty:', queue.isEmpty('orders')); // false
    
    // Peek at next item without removing it
    let nextOrder = queue.peek('orders');
    console.log('Next order:', nextOrder); // order-456
}
```

### Advanced Operations

```javascript
import queue from 'k6/x/queue';

export default function () {
    // Pop with timeout (waits up to 5000ms for an item)
    let item = queue.popWithTimeout('delayed-queue', 5000);
    if (item === null) {
        console.log('No item available within timeout');
    }
    
    // Clear all items from a queue
    queue.clear('orders');
    
    // List all queue names
    let queueNames = queue.listQueues();
    console.log('Available queues:', queueNames);
}
```

### Solving Cross-VU Data Sharing

This extension solves the common k6 problem where data generated by one scenario needs to be consumed by another:

```javascript
import queue from 'k6/x/queue';
import { check } from 'k6';

export let options = {
    scenarios: {
        orderCreation: {
            executor: 'constant-arrival-rate',
            rate: 1, // 1 TPS
            timeUnit: '1s',
            duration: '60m',
            preAllocatedVUs: 2,
            maxVUs: 10,
            exec: 'createOrders'
        },
        fulfillmentFlow01: {
            executor: 'constant-arrival-rate',
            rate: 1, // 1 TPS  
            timeUnit: '1s',
            duration: '55m',
            startTime: '5m', // Start after 5 minutes
            preAllocatedVUs: 2,
            maxVUs: 10,
            exec: 'fulfillOrders01'
        },
        fulfillmentFlow02: {
            executor: 'constant-arrival-rate',
            rate: 1, // 1 TPS
            timeUnit: '1s', 
            duration: '40m',
            startTime: '20m', // Start after 20 minutes
            preAllocatedVUs: 2,
            maxVUs: 10,
            exec: 'fulfillOrders02'
        }
    }
};

// Order Creation Flow - Generates logisticOrderIds
export function createOrders() {
    let logisticOrderId = `order-${Date.now()}-${Math.random()}`;
    
    // Simulate order creation API call
    // ... your API calls here ...
    
    // Push the generated order ID to the queue
    queue.push('logistic-orders', logisticOrderId);
    console.log(`Created order: ${logisticOrderId}`);
}

// Fulfillment Flow 01 - Consumes logisticOrderIds, generates distributionOrderIds
export function fulfillOrders01() {
    // Try to get an order with 10 second timeout
    let logisticOrderId = queue.popWithTimeout('logistic-orders', 10000);
    
    if (logisticOrderId === null) {
        console.log('No orders available for fulfillment');
        return;
    }
    
    // Process the order
    let distributionOrderId = `dist-${logisticOrderId}-${Date.now()}`;
    let lastMileId = `lm-${logisticOrderId}-${Date.now()}`;
    
    // Simulate fulfillment API calls
    // ... your API calls here ...
    
    // Push data for next flow
    queue.push('distribution-orders', {
        distributionOrderId: distributionOrderId,
        lastMileId: lastMileId,
        originalOrderId: logisticOrderId
    });
    
    console.log(`Fulfilled order: ${logisticOrderId} -> ${distributionOrderId}`);
}

// Fulfillment Flow 02 - Consumes data from Flow 01
export function fulfillOrders02() {
    // Try to get distribution data with 10 second timeout
    let orderData = queue.popWithTimeout('distribution-orders', 10000);
    
    if (orderData === null) {
        console.log('No distribution orders available');
        return;
    }
    
    // Process the distribution order
    // ... your API calls here ...
    
    console.log(`Processed distribution order: ${orderData.distributionOrderId}`);
}
```

## API Reference

### `push(queueName, item)`
Adds an item to the specified queue.
- `queueName` (string): Name of the queue
- `item` (any): Item to add to the queue

### `pop(queueName)`
Removes and returns the first item from the queue. Returns `null` if queue is empty.
- `queueName` (string): Name of the queue
- Returns: First item in queue or `null`

### `popWithTimeout(queueName, timeoutMs)`
Removes and returns the first item from the queue, waiting up to `timeoutMs` milliseconds.
- `queueName` (string): Name of the queue
- `timeoutMs` (number): Maximum time to wait in milliseconds
- Returns: First item in queue or `null` if timeout reached

### `peek(queueName)`
Returns the first item without removing it. Returns `null` if queue is empty.
- `queueName` (string): Name of the queue
- Returns: First item in queue or `null`

### `size(queueName)`
Returns the number of items in the queue.
- `queueName` (string): Name of the queue
- Returns: Number of items (integer)

### `isEmpty(queueName)`
Returns true if the queue is empty.
- `queueName` (string): Name of the queue
- Returns: Boolean indicating if queue is empty

### `clear(queueName)`
Removes all items from the queue.
- `queueName` (string): Name of the queue

### `listQueues()`
Returns an array of all queue names.
- Returns: Array of queue names (strings)

## Thread Safety

All operations are thread-safe and can be safely called from multiple VUs simultaneously. The extension uses Go's sync.RWMutex and sync.Cond to ensure data consistency and proper coordination between concurrent operations.

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the MIT License - see the LICENSE file for details.